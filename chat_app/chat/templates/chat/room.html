<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="utf-8">
    <!--  This file has been downloaded from bootdey.com @bootdey on twitter -->
    <!--  All snippets are MIT license http://bootdey.com/license -->
    <title>bs4 simple chat app - Bootdey.com</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link href = "{% static 'css/chat_app.css' %}" rel = "stylesheet" />



</head>
<body>
<div class="container">

    <!-- Page header start -->
    <div class="page-title">
        <div class="row gutters">
            <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12 col-12">
                <h5 class="title">Chat App</h5>
            </div>
            <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12 col-12"> </div>
        </div>
    </div>
    <!-- Page header end -->

    <!-- Content wrapper start -->
    <div class="content-wrapper">

        <!-- Row start -->
        <div class="row gutters">

            <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">

                <div class="card m-0">

                    <!-- Row start -->
                    <div class="row no-gutters">
                        <div class="col-xl-4 col-lg-4 col-md-4 col-sm-3 col-3">
                            <div class="users-container">
                                <div class="chat-search-box">
                                    <div class="input-group">
                                        <input class="form-control" placeholder="Search">
                                        <div class="input-group-btn">
                                            <button type="button" class="btn btn-info">
                                                <i class="fa fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <ul class="users">
                                    <li class="person" data-chat="person1">
                                        <div class="user">
                                            <img src="https://www.bootdey.com/img/Content/avatar/avatar3.png" alt="Retail Admin">
                                            <span class="status busy"></span>
                                        </div>
                                        <p class="name-time">
                                            <span class="name">Steve Bangalter</span>
                                            <span class="time">15/02/2019</span>
                                        </p>
                                    </li>

                                    <li class="person active-user" data-chat="person2">
                                        <div class="user">
                                            <img src="https://www.bootdey.com/img/Content/avatar/avatar2.png" alt="Retail Admin">
                                            <span class="status away"></span>
                                        </div>
                                        <p class="name-time">
                                            <span class="name">Peter Gregor</span>
                                            <span class="time">12/02/2019</span>
                                        </p>
                                    </li>
                                    <li class="person" data-chat="person3">
                                        <div class="user">
                                            <img src="https://www.bootdey.com/img/Content/avatar/avatar3.png" alt="Retail Admin">
                                            <span class="status busy"></span>
                                        </div>
                                        <p class="name-time">
                                            <span class="name">Jessica Larson</span>
                                            <span class="time">11/02/2019</span>
                                        </p>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-xl-8 col-lg-8 col-md-8 col-sm-9 col-9">
                            <div class="selected-user">
                                <span>To: <span class="name">Emily Russell</span></span>
                            </div>
                            <div class="chat-container" id = "chat-container">
                                <ul class="chat-box chatContainerScroll" id = "chat-messages-output">
                                    <li class="chat-left">
                                        <div class="chat-avatar">
                                            <img src="https://www.bootdey.com/img/Content/avatar/avatar3.png" alt="avatar">
                                            <div class="chat-name">Russell</div>
                                        </div>
                                        <div class="chat-text">Hello, I'm Russell.
                                            <br>How can I help you today?</div>
                                        <div class="chat-hour">08:55 <span class="fa fa-check-circle"></span></div>
                                    </li>
                                    <li class="chat-right">
                                        <div class="chat-hour">08:56 <span class="fa fa-check-circle"></span></div>
                                        <div class="chat-text">Hi, Russell
                                            <br> I need more information about Developer Plan.</div>
                                        <div class="chat-avatar">
                                            <img src="https://www.bootdey.com/img/Content/avatar/avatar3.png" alt="avatar">
                                            <div class="chat-name">Sam</div>
                                        </div>
                                    </li>
                                    <li class="chat-left">
                                        <div class="chat-avatar">
                                            <img src="https://www.bootdey.com/img/Content/avatar/avatar3.png" alt="avatar">
                                            <div class="chat-name">Russell</div>
                                        </div>
                                        <div class="chat-text">Are we meeting today?
                                            <br>Project has been already finished and I have results to show you.</div>
                                        <div class="chat-hour">08:57 <span class="fa fa-check-circle"></span></div>
                                    </li>
                                    <li class="chat-right">
                                        <div class="chat-hour">08:59 <span class="fa fa-check-circle"></span></div>
                                        <div class="chat-text">Well I am not sure.
                                            <br>I have results to show you.</div>
                                        <div class="chat-avatar">
                                            <img src="https://www.bootdey.com/img/Content/avatar/avatar5.png" alt="avatar">
                                            <div class="chat-name">Joyse</div>
                                        </div>
                                    </li>
                                </ul>
                                <div class="form-group mt-3 mb-0">
                                    <textarea class="form-control" rows="3" placeholder="Type your message here..." id = "chat-message-input"></textarea>
                                    <button class = "form-control" id = "chat-message-submit">Send</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Row end -->
                </div>

            </div>

        </div>
        <!-- Row end -->

    </div>
    <!-- Content wrapper end -->

</div>


<script src = "{% static 'js/reconnecting-websocket.min.js' %}"></script>

<script>

    var roomName = {{ room_name }};
    var username = {{ username }};

    
    const sendMsg = (socket) => {
        const messageInputDom = document.querySelector("#chat-message-input");
        const message = messageInputDom.value; 
        socket.send(JSON.stringify({ //send message once the chat message is submitted
            'message': message, 
            'command': 'new_message',
            'from':username
        }));
        
        messageInputDom.value = ''; 
    };
    


    const chatSocket = new ReconnectingWebSocket(  //create a webSocket
        'ws://' + 
        window.location.host + 
        '/ws/chat/' + 
        roomName + 
        '/'
    ); 
    chatSocket.onmessage = function (e) { //function ran when a message is sent to the socket
        const data = JSON.parse(e.data)
        console.log(data)
        const message = data.message;
        const author = data.author;
        let received = true;

        if (author === username) {
            received = false;
        }
        document.getElementById("chat-messages-output").innerHTML += getMsgHtml(author, message,received);
        
    }; 

    chatSocket.onclose = function (e) {
        console.error("Chat socket closed unexpectedly"); 
    }

    document.querySelector("#chat-message-submit").onclick = function (e) {
        sendMsg(chatSocket)
    };
    // document.getElementById("chat-message-input").onkeydown = function (e) {
    //     if (e.keyCode === 13) {
    //         sendMsg(chatSocket)
    //     }
    // }


    function getMsgHtml (usernameParam, content, received, imgPath = null) {
        
        var now = new Date();
        let chatAvatar = `<div class="chat-avatar">
                <img src="${imgPath}" alt="avatarPic">
                <div class="chat-name">${usernameParam}</div>
            </div>`
        let chatHour = `<div class="chat-hour">${now.getHours() + ":" + now.getMinutes()}<span class="fa fa-check-circle"></span></div>`

        if (received) {
            let html = `
            <li class="chat-left">
                ${chatAvatar}
                <div class="chat-text">${content.replace("\n", '<br/>')}</div>
                ${chatHour}    
            </li>`;
            return html;
        }
        else {
            let html = `
            <li class="chat-right">
                ${chatHour}
                <div class="chat-text">${content.replace("\n", '<br/>')}</div>
                ${chatAvatar}    
            </li>`
            return html;
        }
    }

    function htmlDecode(value) {
        return $("<textarea/>").html(value).text();
      }

</script>
</body>
</html>